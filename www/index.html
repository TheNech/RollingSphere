<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Rolling Sphere</title>
	<script type="text/javascript" src="./lib/socket.io.js"></script>
	<script type="text/javascript" src="./lib/jquery.min.js"></script>
	<script type="text/javascript" src="./lib/three.min.js"></script>
	<script type="text/javascript" src="./lib/OrbitControls.js"></script>
	<script type="text/javascript" src="./bootstrap/js/bootstrap.min.js"></script> 

	<link href="./css/style.css" rel="stylesheet">
	<link href="./bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="./bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
</head>
<body>
	<div id="container"></div>

	<div id="overlay-start">
		<p>Rolling Sphere</p>
		<form id="inputs">			
			<input id="inputNickname" class="form-control" name="nickname" placeholder="Your nickname">
			<input id="inputPassword" class="form-control" name="password" placeholder="Your password" type="password">
			<div id="validationAuth" class="validation"></div>
			<div id="buttons">
				<button id="btnReg" class="btn-link active" type="button">Registration</button>
				<button id="btnEnter" class="btn btn-primary" type="button">Login</button>	
			</div>
		</form>		
	</div>

	<script type="text/javascript">	

		var bestscore, Coins, time;

		$("#btnEnter").on('click', (function() {

			var nick = $('#inputNickname').val(),
				pass = $('#inputPassword').val();

			nick.trim();
			pass.trim();

			if (nick.length == 0 || pass.length == 0) {
				document.getElementById('validationAuth').style.display = 'block';
				document.getElementById('validationAuth').innerHTML = 'Not all fields are filled';
				$('#validationAuth').addClass('error');
			} else {
				socket.emit('auth', { username: nick, password: pass });						
			}

			socket.on('auth', function (data) {
				if (data.successfully) {

					$('#overlay-start').fadeOut(50);
					$('#mainScreen').fadeIn(50);
					document.getElementById('mainScreenElements').style.visibility = "visible";

					bestscore = data.bestscore;
					Coins = data.coins;
					time = data.time;
					$('#mainScreenStatistic p:nth-child(1)').text('Nickname: ' + nick);
					$('#mainScreenStatistic p:nth-child(2)').text('Best score: ' + bestscore);
					$('#mainScreenStatistic p:nth-child(3)').text('Coins: ' + Coins);
					$('#mainScreenStatistic p:nth-child(4)').text('Total time: ' + Math.floor(time / 1000) + 's');

					data.topscores.forEach(function (item, i) {
				      $('#mainScreenTop > tbody > tr:nth-child(' + (i + 1) + ') > td:nth-child(1)').text(i + 1);
				      $('#mainScreenTop > tbody > tr:nth-child(' + (i + 1) + ') > td:nth-child(2)').text(item.username);
				      $('#mainScreenTop > tbody > tr:nth-child(' + (i + 1) + ') > td:nth-child(3)').text(item.score);
				    });

				    socket.on('update-top-score', function (data) {

				      data.scores.forEach(function (item, i) {
				        $('#mainScreenTop > tbody > tr:nth-child(' + (i + 1) + ') > td:nth-child(1)').text(i + 1);
				        $('#mainScreenTop > tbody > tr:nth-child(' + (i + 1) + ') > td:nth-child(2)').text(item.username);
				        $('#mainScreenTop > tbody > tr:nth-child(' + (i + 1) + ') > td:nth-child(3)').text(item.score);
				      });

				    })
				    .on('update-online', function (data) {
				    	$('#mainScreenOnline p').text('Online: ' + data.pOnline);
				    })
				    .on('player-data', function (data) {
				    	$('#mainScreenStatistic p:nth-child(2)').text('Best score: ' + data.bestscore);
					    $('#mainScreenStatistic p:nth-child(3)').text('Coins: ' + data.coins);
					    $('#mainScreenStatistic p:nth-child(4)').text('Total time: ' + Math.floor(data.time / 1000) + 's'); 

					    if (data.coins < continueFor) {
					    	document.getElementById('btn-continue').disabled = true;
					    	document.getElementById('btn-continue').title = 'You do not have enough coins';
					    } else {
					    	$('#btn-continue').removeAttr('title');
					    }
				    });

				} else {
					document.getElementById('validationAuth').style.display = 'block';
					document.getElementById('validationAuth').innerHTML = 'Authorization failed! Please enter correct data';
					$('#validationAuth').addClass('error');
				}
			});
		}));
		
		$("#inputs").trigger('reset');		
	</script>
	
	<div id="modalBoxReg" class="modal fade" data-backdrop="static">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<div class="modal-header">
					<button class="close" type="button" data-dismiss="modal">
						&times;
					</button>
					<h4 class="modal-title">Registration</h4>
				</div>
				<div class="modal-body">
					<form id="inpReg">
						<input id="inputNick" class="form-control" name="nickname" placeholder="Your nickname" required>
						<input id="inputPass" class="form-control" name="password" placeholder="Your password" type="password">	
						<input id="inputRepeatPass" class="form-control" name="repeatPass" placeholder="Repeat your password" type="password">
					</form>
					<div id="validationReg" class="validation"></div>
				</div>				
				<div class="modal-footer">
					<button id="btnRegRegistr" class="btn btn-primary" type="button">Registration</button>
					<button id="btnRegClose" class="btn btn-danger" type="button" data-dismiss="modal">Close</button>
				</div>			
			</div>
		</div>
	</div>

	<script type="text/javascript">

		$('#btnReg').on('click', function () {
			$('#modalBoxReg').modal('show');
		});

		$('#btnRegRegistr').on('click', function () {

			var nick = $('#inputNick').val(),
				pass = $('#inputPass').val(),
				repeatPass = $('#inputRepeatPass').val();

			nick.trim();
			pass.trim();
			repeatPass.trim();
			
			if (nick.length == 0 || pass.length == 0 || repeatPass.length == 0) {
				document.getElementById('validationReg').style.display = 'block';
				document.getElementById('validationReg').innerHTML = 'Fields must not be empty';
				$('#validationReg').addClass('error');
			} else {
				if (nick.length < 3 || nick.length > 15) {
					document.getElementById('validationReg').style.display = 'block';
					document.getElementById('validationReg').innerHTML = 'Nickname must be more than 3 and less than 15 characters';
					$('#validationReg').addClass('error');
				} else {
					if (pass.length < 5) {
						document.getElementById('validationReg').style.display = 'block';
						document.getElementById('validationReg').innerHTML = 'Password must be at least 5 characters';
						$('#validationReg').addClass('error');
					} else {
						if (pass != repeatPass) {
							document.getElementById('validationReg').style.display = 'block';
							document.getElementById('validationReg').innerHTML = 'Passwords do not match';
							$('#validationReg').addClass('error');
							} else {
								socket.emit('registration', { username: nick, password: pass });
							}
					}					
				}
			}

			socket.on('registration', function (data) {
				if (data.successfully) {
					document.getElementById('validationReg').style.display = 'block';
					document.getElementById('validationReg').innerHTML = 'You are successfully registered';
					if ($('#validationReg').hasClass('error')) {
						$('#validationReg').removeClass('error');
						$('#validationReg').addClass('success');									
					} else {
						$('#validationReg').addClass('success');
					}
				} else {
					document.getElementById('validationReg').style.display = 'block';
					document.getElementById('validationReg').innerHTML = 'Registration failed! User with such a nickname already exists';
					$('#validationReg').addClass('error');	
				}
			});
		});

		$('#inpReg').trigger('reset');
	</script>

	<div id="modalBoxResult" class="modal fade" data-backdrop="static">
		<div class="modal-dialog modal-sm">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Result</h4>
				</div>
				<div class="modal-body">
					<p></p>
					<p></p>
					<p></p>
					<p></p>
					<p>Continue for 50 coins</p>
				</div>
				<div class="modal-footer btn-group">
					<button id="btn-OK" class="btn btn-success" type="button"><font>OK</font></button>
					<button id="btn-restart" class="btn btn-primary" type="button">Restart</button>
					<button id="btn-continue" class="btn btn-warning" type="button">Continue</button>
				</div>
			</div>
		</div>
	</div>

	<div id="mainScreen">
		<div id="mainScreenElements">
			<h1 id="mainScreenTitle">Rolling Sphere</h1>
			<div id="mainScreenOnline">
				<p>Online: </p>
			</div>
			
			<div id="mainScreenStatistic">				
				<p>Nickname: </p>
				<p>Best score: </p>
				<p>Coins: </p>	
				<p>Total time: </p>				
			</div>
			<table id="mainScreenTop">
				<caption>Top</caption>
				<tr><td></td><td></td><td></td></tr>
				<tr><td></td><td></td><td></td></tr>
				<tr><td></td><td></td><td></td></tr>
				<tr><td></td><td></td><td></td></tr>
				<tr><td></td><td></td><td></td></tr>
				<tr><td></td><td></td><td></td></tr>
				<tr><td></td><td></td><td></td></tr>
			</table>		

			<div id="btnStartGame">
				<button type="button" class="btn btn-primary">Play</button>
			</div>			
		</div>		
	</div>

	<div id="score"><p>Score: 0</p></div>
	<div id="coins"><p>Coins: 0</p></div>
	<script type="text/javascript" src="./js/game.js"></script>
	<script type="text/javascript">
		var socket = io('http://localhost:8080');
		socket.on('connected', function(data) {
			console.log('My id : ' + data.id);
		});
		socket.on('new-player-connected', function(data) {
			console.log('New player was connected. Id: ' + data.id + "\tCurrent number of players is " + data.pNumber);
		});
		socket.on('player-disconnected', function(data) {
			console.log('Player was disconnected. Id: ' + data.id + "\tCurrent number of players is " + data.pNumber);
		});

		socket.on('new-global-top-score', function(data){
			console.log('new-global-top-score');
  			console.log(data);
  			console.log();
		});
	</script>
</body>
</html>
